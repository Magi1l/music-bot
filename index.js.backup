// í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
require('dotenv').config();

const { Client, GatewayIntentBits, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } = require('discord.js');
const axios = require('axios');
const cheerio = require('cheerio');
const cron = require('node-cron');
const { DisTube } = require('distube');
const { SpotifyPlugin } = require('@distube/spotify');

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildVoiceStates,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent
  ]
});

// DisTube ì´ˆê¸°í™” (ìŠ¤í¬í‹°íŒŒì´ í”ŒëŸ¬ê·¸ì¸ ì¶”ê°€)
const distube = new DisTube(client, {
  plugins: [new SpotifyPlugin()],
  searchSongs: 5, // ê²€ìƒ‰ ê²°ê³¼ ìˆ˜
  searchCooldown: 30, // ê²€ìƒ‰ ì¿¨ë‹¤ìš´ (ì´ˆ)
  leaveOnEmpty: true, // ì±„ë„ì´ ë¹„ì–´ìˆì„ ë•Œ ë‚˜ê°€ê¸°
  leaveOnFinish: false, // ì¬ìƒ ì™„ë£Œ í›„ ë‚˜ê°€ì§€ ì•ŠìŒ
  leaveOnStop: false // ì •ì§€ ì‹œ ë‚˜ê°€ì§€ ì•ŠìŒ
});

// ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì„¤ì • ì €ì¥ì†Œ
const websiteConfig = new Map();

// í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
const { DISCORD_TOKEN, YOUTUBE_COOKIE } = process.env;

// ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ í•¨ìˆ˜
async function checkWebsite(guildId) {
  const config = websiteConfig.get(guildId);
  if (!config) return;

  try {
    const response = await axios.get(config.url);
    const $ = cheerio.load(response.data);
    const html = response.data;
    
    // ê²Œì‹œê¸€ ìš”ì†Œ ìë™ íƒìƒ‰
    const posts = [];
    const postElements = $('div, article, section, li').toArray();
    
    for (const el of postElements) {
      const $el = $(el);
      
      // ê²Œì‹œê¸€ì´ ì•„ë‹Œ ìš”ì†Œ í•„í„°ë§
      if (!isPostElement($el)) continue;
      
      // ê²Œì‹œê¸€ ì •ë³´ ì¶”ì¶œ
      const post = {
        id: getPostId($el),
        title: getPostTitle($el),
        link: getPostLink($el),
        date: getPostDate($el),
        image: getPostImage($el)
      };
      
      if (post.title && post.link) {
        posts.push(post);
      }
    }

    function isPostElement($el) {
      // ê²Œì‹œê¸€ì´ ì•„ë‹Œ ìš”ì†Œ í•„í„°ë§
      const text = $el.text().trim();
      return text.length > 0 && !text.includes('í˜ì´ì§€') && !text.includes('ê²€ìƒ‰');
    }

    function getPostId($el) {
      return $el.attr('id') || $el.attr('data-id') || $el.attr('data-post-id') || $el.attr('data-article-id') || Date.now().toString();
    }

    function getPostTitle($el) {
      // ì œëª©ì„ ì°¾ëŠ” ì—¬ëŸ¬ ë°©ë²• ì‹œë„
      const titleSelectors = [
        'h1, h2, h3, h4, h5, h6',
        '.title, .post-title, .article-title',
        'a[href]:contains("read")',
        'a[href]:contains("view")'
      ];
      
      for (const selector of titleSelectors) {
        const title = $el.find(selector).text().trim();
        if (title) return title;
      }
      return '';
    }

    function getPostLink($el) {
      // ë§í¬ë¥¼ ì°¾ëŠ” ì—¬ëŸ¬ ë°©ë²• ì‹œë„
      const linkSelectors = [
        'a[href]',
        'button[href]',
        '[data-href]',
        '[data-link]'
      ];
      
      for (const selector of linkSelectors) {
        const link = $el.find(selector).attr('href');
        if (link) return link.startsWith('http') ? link : config.url + link;
      }
      return '';
    }

    function getPostDate($el) {
      // ë‚ ì§œë¥¼ ì°¾ëŠ” ì—¬ëŸ¬ ë°©ë²• ì‹œë„
      const dateSelectors = [
        '.date, .post-date, .article-date',
        'time',
        'span[data-date]',
        'div[data-date]'
      ];
      
      for (const selector of dateSelectors) {
        const date = $el.find(selector).text().trim();
        if (date) return date;
      }
      return '';
    }

    function getPostImage($el) {
      // ì´ë¯¸ì§€ë¥¼ ì°¾ëŠ” ì—¬ëŸ¬ ë°©ë²• ì‹œë„
      const imageSelectors = [
        'img',
        '[data-image]',
        '[data-src]',
        '[style*="background-image"]'
      ];
      
      for (const selector of imageSelectors) {
        const $img = $el.find(selector);
        if ($img.length > 0) {
          const src = $img.attr('src') || 
                    $img.attr('data-image') || 
                    $img.attr('data-src') || 
                    $img.css('background-image').replace(/url\("|"\)/g, '');
          if (src) return src.startsWith('http') ? src : config.url + src;
        }
      }
      return null;
    }

    if (posts.length > 0 && posts[0].id !== config.lastPostId) {
      config.lastPostId = posts[0].id;
      
      const channel = client.channels.cache.get(config.channelId);
      if (channel) {
        const post = posts[0];
        const embed = new EmbedBuilder()
          .setTitle('ìƒˆë¡œìš´ ê²Œì‹œê¸€ì´ ì˜¬ë¼ì™”ì–´ìš”!')
          .setDescription(`[${post.title}](${post.link})`)
          .addFields(
            { name: 'ë‚ ì§œ', value: post.date || 'ë¯¸ì§€ì •', inline: true }
          )
          .setColor('Random');

        // ì´ë¯¸ì§€ë‚˜ ë¹„ë””ì˜¤ê°€ ìˆì„ ê²½ìš° Embedì— ì¶”ê°€
        if (post.image) {
          embed.setThumbnail(post.image);
        }

        // ë¹„ë””ì˜¤ê°€ ìˆì„ ê²½ìš° URL ì¶”ê°€
        if (post.link.includes('youtube') || post.link.includes('vimeo')) {
          embed.addFields({
            name: 'ë¹„ë””ì˜¤ ë§í¬',
            value: `[í´ë¦­í•˜ì—¬ ì‹œì²­](${post.link})`,
            inline: true
          });
        }

        await channel.send({ embeds: [embed] });
      }
    }
  } catch (error) {
    console.error(`ì„œë²„ ${guildId}ì˜ ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜:`, error);
  }
}

// ì£¼ê¸°ì ì¸ í¬ë¡¤ë§ ì„¤ì •
function setupCron(guildId) {
  const config = websiteConfig.get(guildId);
  if (config && config.cron) {
    config.cron.destroy();
  }

  if (config && config.url && config.channelId) {
    config.cron = cron.schedule(`*/${Math.floor(config.interval / 60000)} * * * *`, () => checkWebsite(guildId));
  }
}

const nowPlayingMessages = new Map();
// ê²€ìƒ‰ ê²°ê³¼ ì„ì‹œ ì €ì¥ì„ ìœ„í•œ ìºì‹œ
const searchResultsCache = new Map();

client.once('ready', () => {
  console.log(`${client.user.tag} ì˜¨ë¼ì¸!`);
  registerCommands();
});

// ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ ë“±ë¡
async function registerCommands() {
  try {
    console.log('ëª…ë ¹ì–´ ë“±ë¡ ì‹œì‘...');
    
    // ëª…ë ¹ì–´ ì •ì˜
    const commands = [
      // ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ê´€ë ¨ ëª…ë ¹ì–´
      {
        name: 'ì›¹ì‚¬ì´íŠ¸ì„¤ì •',
        description: 'ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì„¤ì •ì„ ì €ì¥í•©ë‹ˆë‹¤.',
        options: [
          {
            name: 'url',
            description: 'í¬ë¡¤ë§í•  ì›¹ì‚¬ì´íŠ¸ URL',
            type: 3,
            required: true
          },
          {
            name: 'ì±„ë„',
            description: 'ì•Œë¦¼ì„ ë³´ë‚¼ ì±„ë„',
            type: 7,
            required: true
          },
          {
            name: 'ê°„ê²©',
            description: 'í¬ë¡¤ë§ ê°„ê²© (ë¶„)',
            type: 4,
            required: false,
            minValue: 1,
            maxValue: 1440
          }
        ]
      },
      {
        name: 'ì›¹ì‚¬ì´íŠ¸ì¡°íšŒ',
        description: 'í˜„ì¬ ì„¤ì •ëœ ì›¹ì‚¬ì´íŠ¸ ì„¤ì •ì„ í™•ì¸í•©ë‹ˆë‹¤.'
      },
      {
        name: 'ì›¹ì‚¬ì´íŠ¸ì‚­ì œ',
        description: 'ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì„¤ì •ì„ ì‚­ì œí•©ë‹ˆë‹¤.'
      },
      // ìŒì•… ê´€ë ¨ ëª…ë ¹ì–´
      {
        name: 'play',
        description: 'ìŒì•…ì„ ì¬ìƒí•©ë‹ˆë‹¤.',
        options: [
          {
            name: 'query',
            description: 'ê²€ìƒ‰ì–´ ë˜ëŠ” URL',
            type: 3,
            required: true
          }
        ]
      },
      {
        name: 'skip',
        description: 'í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ê³¡ì„ ê±´ë„ˆëœë‹ˆë‹¤.'
      },
      {
        name: 'queue',
        description: 'ì¬ìƒ ëŒ€ê¸°ì—´ì„ í™•ì¸í•©ë‹ˆë‹¤.'
      },
      {
        name: 'stop',
        description: 'ì¬ìƒì„ ì¤‘ì§€í•©ë‹ˆë‹¤.'
      }
    ];

    // ì „ì—­ ëª…ë ¹ì–´ë¡œ ë“±ë¡ (ëª¨ë“  ì„œë²„ì— ì ìš©)
    console.log(`${commands.length}ê°œì˜ ëª…ë ¹ì–´ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤...`);
    await client.application.commands.set(commands);
    console.log('ëª…ë ¹ì–´ ë“±ë¡ ì™„ë£Œ!');
  } catch (error) {
    console.error('ëª…ë ¹ì–´ ë“±ë¡ ì¤‘ ì˜¤ë¥˜:', error);
  }
}
run = "npm start"

// ìŠ¬ë˜ì‹œ ëª…ë ¹ì–´ ì²˜ë¦¬
client.on('interactionCreate', async interaction => {
  if (!interaction.isCommand()) return;

  const { commandName, options } = interaction;

  // ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ê´€ë ¨ ëª…ë ¹ì–´ ì²˜ë¦¬
  switch (commandName) {
    case 'ì›¹ì‚¬ì´íŠ¸ì„¤ì •': {
      // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
      if (!interaction.member.permissions.has('Administrator')) {
        return interaction.reply({ content: 'ì´ ëª…ë ¹ì–´ëŠ” ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', ephemeral: true });
      }

      const url = options.getString('url');
      const channel = options.getChannel('ì±„ë„');
      const interval = options.getInteger('ê°„ê²©') || 5;

      if (!channel.isText()) {
        return interaction.reply({ content: 'ì±„ë„ì€ í…ìŠ¤íŠ¸ ì±„ë„ì´ì–´ì•¼ í•©ë‹ˆë‹¤.', ephemeral: true });
      }

      websiteConfig.set(interaction.guildId, {
        url,
        channelId: channel.id,
        interval: interval * 60000, // ë¶„ì„ ë°€ë¦¬ì´ˆë¡œ ë³€í™˜
        lastPostId: null,
        cron: null
      });

      setupCron(interaction.guildId);
      return interaction.reply({ content: `ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\nURL: ${url}\nì•Œë¦¼ ì±„ë„: ${channel.name}\ní¬ë¡¤ë§ ê°„ê²©: ${interval}ë¶„`, ephemeral: true });
    }
    case 'ì›¹ì‚¬ì´íŠ¸ì¡°íšŒ': {
      // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
      if (!interaction.member.permissions.has('Administrator')) {
        return interaction.reply({ content: 'ì´ ëª…ë ¹ì–´ëŠ” ê´€ë¦¬ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', ephemeral: true });
      }

      const config = websiteConfig.get(interaction.guildId);
      if (!config) {
        return interaction.reply({ content: 'ì„¤ì •ëœ ì›¹ì‚¬ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.', ephemeral: true });
      }
      return interaction.reply({
        content: `í˜„ì¬ ì„¤ì •:\nURL: ${config.url}\nì•Œë¦¼ ì±„ë„: <#${config.channelId}>\ní¬ë¡¤ë§ ê°„ê²©: ${(config.interval / 60000)}ë¶„`,
        ephemeral: true
      });
    }
    break;
  case 'play':
    try {
      const query = interaction.options.getString('query');
      const member = interaction.member;
      if (!member.voice.channelId) return interaction.reply({ content: 'ìŒì„± ì±„ë„ì— ë¨¼ì € ë“¤ì–´ê°€ì„¸ìš”!', ephemeral: true });

      // ìŒì„± ì±„ë„ ê°ì²´ ê°€ì ¸ì˜¤ê¸°
      const voiceChannel = interaction.guild.channels.cache.get(member.voice.channelId);
      if (!voiceChannel) {
        return interaction.reply({ content: 'ìŒì„± ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', ephemeral: true });
      }
      
      console.log(`ìŒì„± ì±„ë„ ì •ë³´: ${voiceChannel.name}, íƒ€ì…: ${voiceChannel.type}`);
      
      // ê²€ìƒ‰ ì‹¤í–‰
      // ì‘ë‹µì„ ì§€ì—°í•˜ê³  ì‚¬ìš©ìì—ê²Œ ì²˜ë¦¬ ì¤‘ì„ì„ í‘œì‹œ
      await interaction.deferReply({ ephemeral: false }).catch(err => {
        console.error('ì¸í„°ë ‰ì…˜ ì§€ì—° ì˜¤ë¥˜:', err);
      });
      
      try {
        // ì§ì ‘ ì¬ìƒ ì‹œë„ - DisTube 5.0.7ì—ì„œëŠ” ì´ ë°©ì‹ì„ ì‚¬ìš©
        try {
          // ìœ íŠœë¸Œ ê²€ìƒ‰
          const youtubeResults = await distube.play(voiceChannel, query, {
            member: member,
            textChannel: interaction.channel,
            skip: false,
            position: 1, // í˜„ì¬ ì¬ìƒì¤‘ì¸ ê³³ ë‹¤ìŒì— ì¶”ê°€
            pause: true, // ì¼ë‹¨ ì¼ì‹œì •ì§€
            metadata: { source: 'youtube' }
          });
          
          // ìŠ¤í¬í‹°íŒŒì´ ê²€ìƒ‰ (ìŠ¤í¬í‹°íŒŒì´ URLì´ ì•„ë‹ˆë©´ ê²€ìƒ‰ì–´ì— spotify: ì ‘ë‘ì–´ ì¶”ê°€)
          const spotifyQuery = query.includes('spotify.com') ? query : `spotify:${query}`;
          const spotifyResults = await distube.play(voiceChannel, spotifyQuery, {
            member: member,
            textChannel: interaction.channel,
            skip: false,
            position: 2, // ìœ íŠœë¸Œ ê²€ìƒ‰ ê²°ê³¼ ë‹¤ìŒì— ì¶”ê°€
            pause: true, // ì¼ë‹¨ ì¼ì‹œì •ì§€
            metadata: { source: 'spotify' }
          }).catch(err => {
            console.log('ìŠ¤í¬í‹°íŒŒì´ ê²€ìƒ‰ ì˜¤ë¥˜ (ë¬´ì‹œí•´ë„ ë¨):', err.message);
            return null; // ìŠ¤í¬í‹°íŒŒì´ ê²€ìƒ‰ ì‹¤íŒ¨ëŠ” ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
          });
          
          // í ê°€ì ¸ì˜¤ê¸°
          const queue = distube.getQueue(interaction.guild.id);
          if (!queue) {
            return interaction.editReply({ content: 'íë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë…¸ë˜ ì¬ìƒì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
          }
          
          // íì—ì„œ ê²€ìƒ‰ ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
          const searchResults = queue.songs.slice(1); // í˜„ì¬ ì¬ìƒì¤‘ì¸ ê³± ì œì™¸
          
          // í ì´ˆê¸°í™” (ê²€ìƒ‰ë§Œ ìœ„í•œ ê²ƒì´ì—ˆìœ¼ë‹ˆ ì§€ìš°ê¸°)
          queue.stop();
          
          // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì„ ê²½ìš°
          if (!searchResults || searchResults.length === 0) {
            return interaction.editReply({ content: 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‚¬ìš©í•´ë³´ì„¸ìš”.' });
          }
        } catch (playError) {
          console.error('ì¬ìƒ ì‹œë„ ì¤‘ ì˜¤ë¥˜:', playError);
          return interaction.editReply({ content: `ë…¸ë˜ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${playError.message}` });
        }
        
        // ê²€ìƒ‰ ê²°ê³¼ ë¶„ë¥˜
        const youtubeResults = searchResults.filter(song => !song.metadata || song.metadata.source !== 'spotify');
        const spotifyResults = searchResults.filter(song => song.metadata && song.metadata.source === 'spotify');
        
        // ìœ íŠœë¸Œ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        const youtubeEmbed = new EmbedBuilder()
          .setTitle('ğŸ“º YouTube ê²€ìƒ‰ ê²°ê³¼')
          .setDescription('ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë…¸ë˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.')
          .setColor('#FF0000'); // YouTube ë¹¨ê°„ìƒ‰
        
        // ìœ íŠœë¸Œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ í•„ë“œë¡œ ì¶”ê°€
        youtubeResults.slice(0, 5).forEach((result, index) => {
          youtubeEmbed.addFields({
            name: `${index + 1}. ${result.name}`,
            value: `ì¬ìƒ ì‹œê°„: ${msToTime(result.duration)} | [YouTube ë§í¬](${result.url})`,
            inline: false
          });
        });
        
        // ìŠ¤í¬í‹°íŒŒì´ ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        const spotifyEmbed = new EmbedBuilder()
          .setTitle('ğŸµ Spotify ê²€ìƒ‰ ê²°ê³¼')
          .setDescription('ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë…¸ë˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.')
          .setColor('#1DB954'); // Spotify ì´ˆë¡ìƒ‰
        
        // ìŠ¤í¬í‹°íŒŒì´ ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í•„ë“œë¡œ ì¶”ê°€
        if (spotifyResults.length > 0) {
          spotifyResults.slice(0, 5).forEach((result, index) => {
            spotifyEmbed.addFields({
              name: `${index + 1}. ${result.name}`,
              value: `ì¬ìƒ ì‹œê°„: ${msToTime(result.duration)} | ì•„í‹°ìŠ¤íŠ¸: ${result.uploader?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'}`,
              inline: false
            });
          });
        } else {
          spotifyEmbed.setDescription('ìŠ¤í¬í‹°íŒŒì´ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        // ìœ íŠœë¸Œ ì„ íƒ ë²„íŠ¼ ìƒì„±
        const youtubeRow = new ActionRowBuilder().addComponents(
          new ButtonBuilder().setCustomId('youtube_0').setLabel('1').setStyle(ButtonStyle.Danger),
          new ButtonBuilder().setCustomId('youtube_1').setLabel('2').setStyle(ButtonStyle.Danger),
          new ButtonBuilder().setCustomId('youtube_2').setLabel('3').setStyle(ButtonStyle.Danger),
          new ButtonBuilder().setCustomId('youtube_3').setLabel('4').setStyle(ButtonStyle.Danger),
          new ButtonBuilder().setCustomId('youtube_4').setLabel('5').setStyle(ButtonStyle.Danger)
        );
        
        // ìŠ¤í¬í‹°íŒŒì´ ì„ íƒ ë²„íŠ¼ ìƒì„±
        const spotifyRow = new ActionRowBuilder().addComponents(
          new ButtonBuilder().setCustomId('spotify_0').setLabel('1').setStyle(ButtonStyle.Success),
          new ButtonBuilder().setCustomId('spotify_1').setLabel('2').setStyle(ButtonStyle.Success),
          new ButtonBuilder().setCustomId('spotify_2').setLabel('3').setStyle(ButtonStyle.Success),
          new ButtonBuilder().setCustomId('spotify_3').setLabel('4').setStyle(ButtonStyle.Success),
          new ButtonBuilder().setCustomId('spotify_4').setLabel('5').setStyle(ButtonStyle.Success)
        );
        
        // ìŠ¤í¬í‹°íŒŒì´ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
        if (spotifyResults.length === 0) {
          spotifyRow.components.forEach(button => button.setDisabled(true));
        }
        
        // ì„ì‹œ ì €ì¥
        searchResultsCache.set(interaction.guild.id, {
          youtubeResults,
          spotifyResults,
          voiceChannel,
          member: interaction.member,
          timestamp: Date.now()
        });
        
        // 10ë¶„ í›„ ìºì‹œ ì‚­ì œ (ìë™ ì •ë¦¬)
        setTimeout(() => {
          if (searchResultsCache.has(interaction.guild.id)) {
            searchResultsCache.delete(interaction.guild.id);
          }
        }, 10 * 60 * 1000);
        
        // ìœ íŠœë¸Œ ê²°ê³¼ì™€ ìŠ¤í¬í‹°íŒŒì´ ê²°ê³¼ ëª¨ë‘ í‘œì‹œ
        await interaction.editReply({
          embeds: [youtubeEmbed, spotifyEmbed],
          components: [youtubeRow, spotifyRow]
        });
        
      } catch (error) {
        console.error('ë…¸ë˜ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜:', error);
        await interaction.editReply(`ë…¸ë˜ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
      }
    } catch (error) {
      console.error('ëª…ë ¹ì–´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
      try {
        await interaction.editReply('ëª…ë ¹ì–´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        await interaction.reply({ content: `ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, ephemeral: true });
      } catch {
        // ì´ë¯¸ ì‘ë‹µí•œ ê²½ìš°
        try {
          await interaction.editReply({ content: `ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}` });
        } catch {
          console.error('ì¸í„°ë ‰ì…˜ ì‘ë‹µ ì˜¤ë¥˜');
        }
      }
    }
    break;
  case 'skip':
    try {
      const queue = distube.getQueue(interaction.guild.id);
      if (!queue) return interaction.reply({ content: 'ì¬ìƒ ì¤‘ì¸ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.', ephemeral: true });

      queue.skip();
      interaction.reply({ content: 'ë‹¤ìŒ ê³¡ìœ¼ë¡œ ìŠ¤í‚µí–ˆìŠµë‹ˆë‹¤!', ephemeral: true });
    } catch (error) {
      console.error('ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error);
      await interaction.reply({ content: 'ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', ephemeral: true });
    }
    break;
  case 'queue':
    try {
      const queue = distube.getQueue(interaction.guild.id);
      if (!queue || queue.songs.length === 0) {
        return interaction.reply({ content: 'ì¬ìƒ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.', ephemeral: true });
      }

      const embed = new EmbedBuilder()
        .setTitle('ì¬ìƒ ëª©ë¡')
        .setDescription(queue.songs.map((song, index) => 
          `${index + 1}. [${song.name}](${song.url})`
        ).join('\n'))
        .setColor('Random');

      interaction.reply({ embeds: [embed] });
    } catch (error) {
      console.error('ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error);
      await interaction.reply({ content: 'ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', ephemeral: true });
    }
    break;
  case 'stop':
    try {
      const queue = distube.getQueue(interaction.guild.id);
      if (!queue) return interaction.reply({ content: 'ì¬ìƒ ì¤‘ì¸ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.', ephemeral: true });

      queue.stop();
      interaction.reply({ content: 'ì¬ìƒì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤!', ephemeral: true });
    } catch (error) {
      console.error('ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error);
      await interaction.reply({ content: 'ëª…ë ¹ì–´ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', ephemeral: true });
    }
    break;
  }
});

// ë²„íŠ¼ ì¸í„°ë ‰ì…˜ ì²˜ë¦¬
client.on('interactionCreate', async interaction => {
  if (!interaction.isButton()) return;
  
  try {
    // ê²€ìƒ‰ ê²°ê³¼ ì„ íƒ ë²„íŠ¼ ì²˜ë¦¬
    if (interaction.customId.startsWith('youtube_') || interaction.customId.startsWith('spotify_')) {
      // ì¸í„°ë ‰ì…˜ ì—…ë°ì´íŠ¸ë¥¼ ë””í¼í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ë²„íŠ¼ì´ ì²˜ë¦¬ì¤‘ì„ì„ í‘œì‹œ
      await interaction.deferUpdate().catch(console.error);
      
      const parts = interaction.customId.split('_');
      const source = parts[0]; // youtube ë˜ëŠ” spotify
      const index = parseInt(parts[1]);
      
      // ìºì…˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const cacheData = searchResultsCache.get(interaction.guild.id);
      if (!cacheData) {
        return interaction.followUp({ content: 'ê²€ìƒ‰ ì •ë³´ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.', ephemeral: true });
      }
      
      const { youtubeResults, spotifyResults, voiceChannel, member } = cacheData;
      
      // ì†ŒìŠ¤ì— ë”°ë¼ ê²°ê³¼ ì„ íƒ
      let selectedSong;
      if (source === 'youtube') {
        if (!youtubeResults || !youtubeResults[index]) {
          return interaction.followUp({ content: 'ì„ íƒí•œ YouTube ë…¸ë˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', ephemeral: true });
        }
        selectedSong = youtubeResults[index];
      } else { // spotify
        if (!spotifyResults || !spotifyResults[index]) {
          return interaction.followUp({ content: 'ì„ íƒí•œ Spotify ë…¸ë˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', ephemeral: true });
        }
        selectedSong = spotifyResults[index];
      }
      
      try {
        // ì„ íƒí•œ ë…¸ë˜ ì¬ìƒ
        distube.play(voiceChannel, selectedSong.url, {
          member: member,
          textChannel: interaction.channel
        });
        
        // ì„±ê³µ ë©”ì„¸ì§€
        const embed = new EmbedBuilder()
          .setTitle('ì¬ìƒ ì‹œì‘')
          .setDescription(`[${selectedSong.name}](${selectedSong.url})`)
          .addFields(
            { name: 'ì¬ìƒ ì‹œê°„', value: msToTime(selectedSong.duration), inline: true }
          )
          .setThumbnail(selectedSong.thumbnail)
          .setColor('Random');
        
        // ì›ë˜ ë©”ì„¸ì§€ ì—…ë°ì´íŠ¸ (ë²„íŠ¼ ë¹„í™œì„±í™” ë° ì„±ê³µ ë©”ì„¸ì§€ í‘œì‹œ)
        await interaction.update({ embeds: [embed], components: [] });
        
        // ì¶”ê°€ ì •ë³´ ë©”ì„¸ì§€
        await interaction.followUp({ content: `\u25b6\ufe0f **${selectedSong.name}** ì¬ìƒì„ ì‹œì‘í•©ë‹ˆë‹¤.`, ephemeral: true });
      } catch (error) {
        console.error('ë…¸ë˜ ì¬ìƒ ì¤‘ ì˜¤ë¥˜:', error);
        try {
          await interaction.followUp({ content: `ë…¸ë˜ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, ephemeral: true });
        } catch (followUpError) {
          console.error('ì˜¤ë¥˜ ë©”ì„¸ì§€ ì „ì†¡ ì‹¤íŒ¨:', followUpError);
          try {
            await interaction.update({ content: `ë…¸ë˜ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, components: [] });
          } catch (updateError) {
            console.error('ì¸í„°ë ‰ì…˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', updateError);
          }
        }
      }
      
      return;
    }
    
    // ê¸°ì¡´ ì¬ìƒ ê´€ë ¨ ë²„íŠ¼ ì²˜ë¦¬
    const queue = distube.getQueue(interaction.guild.id);
    if (!queue) return interaction.reply({ content: 'ì¬ìƒ ì¤‘ì¸ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.', ephemeral: true });

    switch (interaction.customId) {
      case 'stop':
        queue.stop();
        await interaction.reply({ content: '\u23f9\ufe0f ì¬ìƒì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.', ephemeral: true });
        break;
      case 'repeat':
        queue.setRepeatMode(queue.repeatMode === 0 ? 1 : 0);
        await interaction.reply({ content: queue.repeatMode === 1 ? '\ud83d\udd01 ë°˜ë³µ ì¬ìƒ ON' : '\ud83d\udd01 ë°˜ë³µ ì¬ìƒ OFF', ephemeral: true });
        break;
      case 'queue':
        if (!queue.songs.length) return interaction.reply({ content: 'ëŒ€ê¸°ì—´ì´ ë¹„ì–´ìˆì–´ìš”.', ephemeral: true });
        const queueList = queue.songs.map((song, i) => `${i + 1}. ${song.name}`).join('\n');
        await interaction.reply({ content: `**ëŒ€ê¸°ì—´**\n${queueList}`, ephemeral: true });
        break;
    }
  } catch (error) {
    console.error('ë²„íŠ¼ ì¸í„°ë ‰ì…˜ ì¤‘ ì˜¤ë¥˜:', error);
    try {
      await interaction.reply({ content: 'ë²„íŠ¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', ephemeral: true });
    } catch {
      try {
        await interaction.editReply({ content: 'ë²„íŠ¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
      } catch {
        console.error('ì¸í„°ë ‰ì…˜ ì‘ë‹µ ì˜¤ë¥˜');
      }
    }
  }
});
        // ì¶”ê°€ ì •ë³´ ë©”ì„¸ì§€
        await interaction.followUp({ content: `\u25b6\ufe0f **${selectedSong.name}** ì¬ìƒì„ ì‹œì‘í•©ë‹ˆë‹¤.`, ephemeral: true });
      } catch (error) {
        console.error('ë…¸ë˜ ì¬ìƒ ì¤‘ ì˜¤ë¥˜:', error);
        try {
          await interaction.followUp({ content: `ë…¸ë˜ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, ephemeral: true });
        } catch (followUpError) {
          console.error('ì˜¤ë¥˜ ë©”ì„¸ì§€ ì „ì†¡ ì‹¤íŒ¨:', followUpError);
          try {
            await interaction.update({ content: `ë…¸ë˜ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`, components: [] });
          } catch (updateError) {
            console.error('ì¸í„°ë ‰ì…˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', updateError);
          }
        }
      }
      
      return;
    }
    
    // ê¸°ì¡´ ì¬ìƒ ê´€ë ¨ ë²„íŠ¼ ì²˜ë¦¬
    const queue = distube.getQueue(interaction.guild.id);
    if (!queue) return interaction.reply({ content: 'ì¬ìƒ ì¤‘ì¸ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.', ephemeral: true });

    switch (interaction.customId) {
      case 'stop':
        queue.stop();
        await interaction.reply({ content: 'â¹ï¸ ì¬ìƒì„ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.', ephemeral: true });
        break;
      case 'repeat':
        queue.setRepeatMode(queue.repeatMode === 0 ? 1 : 0);
        await interaction.reply({ content: queue.repeatMode === 1 ? 'ğŸ” ë°˜ë³µ ì¬ìƒ ON' : 'ğŸ” ë°˜ë³µ ì¬ìƒ OFF', ephemeral: true });
        break;
      case 'queue':
        if (!queue.songs.length) return interaction.reply({ content: 'ëŒ€ê¸°ì—´ì´ ë¹„ì–´ìˆì–´ìš”.', ephemeral: true });
        const queueList = queue.songs.map((song, i) => `${i + 1}. ${song.name}`).join('\n');
        await interaction.reply({ content: `**ëŒ€ê¸°ì—´**\n${queueList}`, ephemeral: true });
        break;
    }
  } catch (error) {
    console.error('ë²„íŠ¼ ì¸í„°ë ‰ì…˜ ì¤‘ ì˜¤ë¥˜:', error);
    try {
      await interaction.reply({ content: 'ë²„íŠ¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', ephemeral: true });
    } catch {
      try {
        await interaction.editReply({ content: 'ë²„íŠ¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' });
      } catch {
        console.error('ì¸í„°ë ‰ì…˜ ì‘ë‹µ ì˜¤ë¥˜');
      }
    }
  }
});

// ë…¸ë˜ ì‹œì‘ ì‹œ ë©”ì„¸ì§€ í‘œì‹œ ë° ë²„íŠ¼ ìƒì„±
distube.on('playSong', async (queue, song) => {
  console.log('ë…¸ë˜ ì¬ìƒ ì‹œì‘:', song.name);
  const channel = client.channels.cache.get(queue.textChannelId);
  if (!channel) return console.log('í…ìŠ¤íŠ¸ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

  try {
    // ì´ì „ ë©”ì„¸ì§€ ì‚­ì œ
    if (nowPlayingMessages.has(queue.guild.id)) {
      try {
        const oldMsg = await channel.messages.fetch(nowPlayingMessages.get(queue.guild.id));
        await oldMsg.delete().catch(() => {});
      } catch (err) {
        console.log('ì´ì „ ë©”ì„¸ì§€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', err);
      }
    }

    const embed = new EmbedBuilder()
      .setTitle('ğŸµ í˜„ì¬ ì¬ìƒ ì¤‘')
      .setDescription(`[${song.name}](${song.url})`)
      .addFields(
        { name: 'ê¸¸ì´', value: msToTime(song.duration), inline: true },
        { name: 'ìš”ì²­ì', value: `<@${song.member.id}>`, inline: true }
      )
      .setThumbnail(song.thumbnail)
      .setColor('Random');

    const row = new ActionRowBuilder().addComponents(
      new ButtonBuilder().setCustomId('stop').setLabel('ì¤‘ì§€').setStyle(ButtonStyle.Danger).setEmoji('â¹ï¸'),
      new ButtonBuilder().setCustomId('repeat').setLabel('ë°˜ë³µ').setStyle(ButtonStyle.Primary).setEmoji('ğŸ”'),
      new ButtonBuilder().setCustomId('queue').setLabel('ëŒ€ê¸°ì—´').setStyle(ButtonStyle.Secondary).setEmoji('ğŸ“œ')
    );

    const msg = await channel.send({ embeds: [embed], components: [row] });
    nowPlayingMessages.set(queue.guild.id, msg.id);
    console.log('ì¬ìƒ ì •ë³´ ë©”ì„¸ì§€ ì „ì†¡ ì™„ë£Œ');
  } catch (error) {
    console.error('íŠ¸ë™ ì‹œì‘ ì•Œë¦¼ ì¤‘ ì˜¤ë¥˜:', error);
  }
});

// ì¬ìƒ ì¢…ë£Œ ì‹œ ë©”ì„¸ì§€ ì‚­ì œ
distube.on('finish', async (queue) => {
  console.log('ì¬ìƒ ì¢…ë£Œ ì´ë²¤íŠ¸ ë°œìƒ');
  const channel = client.channels.cache.get(queue.textChannelId);
  if (!channel) return console.log('í…ìŠ¤íŠ¸ ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  
  if (nowPlayingMessages.has(queue.guild.id)) {
    try {
      const msg = await channel.messages.fetch(nowPlayingMessages.get(queue.guild.id));
      await msg.delete().catch(() => {});
      nowPlayingMessages.delete(queue.guild.id);
    } catch (err) {
      console.log('ë©”ì„¸ì§€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', err);
    }
  }

  try {
    await channel.send('ëª¨ë“  ë…¸ë˜ ì¬ìƒì´ ëë‚¬ì–´ìš”!');
  } catch (error) {
    console.error('ì¬ìƒ ì¢…ë£Œ ì•Œë¦¼ ì¤‘ ì˜¤ë¥˜:', error);
  }
});

// ì˜¤ë¥˜ ì´ë²¤íŠ¸ ì²˜ë¦¬
distube.on('error', (channel, error) => {
  console.error('ìŒì•… ì¬ìƒ ì˜¤ë¥˜:', error);
  if (channel) channel.send(`ìŒì•… ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.toString().slice(0, 1900)}`);
});

// ê²€ìƒ‰ ì´ë²¤íŠ¸ ì²˜ë¦¬
distube.on('searchResult', (message, results) => {
  console.log('ê²€ìƒ‰ ê²°ê³¼:', results.length);
});

// ê²€ìƒ‰ ì·¨ì†Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
distube.on('searchCancel', (message) => {
  console.log('ê²€ìƒ‰ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
  message.channel.send('ê²€ìƒ‰ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
});

// ì—°ê²° ì´ë²¤íŠ¸ ì²˜ë¦¬
distube.on('connectionError', (queue, error) => {
  console.error('ì—°ê²° ì˜¤ë¥˜:', error);
  queue.textChannel.send(`ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.toString().slice(0, 1900)}`);
});

// ì‹œê°„ ë³€í™˜ í•¨ìˆ˜
function msToTime(ms) {
  const sec = Math.floor((ms / 1000) % 60);
  const min = Math.floor((ms / (1000 * 60)) % 60);
  const hr = Math.floor(ms / (1000 * 60 * 60));
  return hr ? `${hr}:${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}` : `${min}:${sec.toString().padStart(2, '0')}`;
}

// ì—ëŸ¬ ì²˜ë¦¬
process.on('unhandledRejection', error => {
  console.error('ë¯¸ì²˜ë¦¬ëœ í”„ë¡œë¯¸ìŠ¤ ê±°ë¶€:', error);
});

let lastPostId = null;

// ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ í•¨ìˆ˜
async function checkWebsite() {
  try {
    const response = await axios.get(process.env.WEBSITE_URL);
    const $ = cheerio.load(response.data);
    
    // ê²Œì‹œê¸€ ì„ íƒì ìˆ˜ì • í•„ìš” (ì‚¬ì´íŠ¸ì— ë§ê²Œ)
    const posts = $('div.post').map((i, el) => ({
      id: $(el).attr('id'),
      title: $(el).find('h3.title').text().trim(),
      link: $(el).find('a').attr('href'),
      date: $(el).find('.date').text().trim()
    })).get();

    if (posts.length > 0) {
      const newestPost = posts[0];
      if (lastPostId !== newestPost.id) {
        lastPostId = newestPost.id;
        
        const channel = client.channels.cache.get(process.env.CHANNEL_ID);
        if (channel) {
          const embed = new EmbedBuilder()
            .setTitle('ìƒˆë¡œìš´ ê²Œì‹œê¸€ì´ ì˜¬ë¼ì™”ì–´ìš”!')
            .setDescription(`[${newestPost.title}](${newestPost.link})`)
            .addFields(
              { name: 'ë‚ ì§œ', value: newestPost.date, inline: true }
            )
            .setColor('Random');

          await channel.send({ embeds: [embed] });
        }
      }
    }
  } catch (error) {
    console.error('ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ ì¤‘ ì˜¤ë¥˜:', error);
  }
}

// ì£¼ê¸°ì ì¸ í¬ë¡¤ë§ ì„¤ì •
if (process.env.WEBSITE_URL && process.env.CHANNEL_ID) {
  cron.schedule(`*/${Math.floor(process.env.CHECK_INTERVAL / 60000)} * * * *`, checkWebsite);
  console.log('ì›¹ì‚¬ì´íŠ¸ í¬ë¡¤ë§ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

// í† í° í™•ì¸
console.log('í† í° í™•ì¸ (ì²˜ìŒ ëª‡ ìë¦¬ë§Œ):', process.env.DISCORD_TOKEN ? process.env.DISCORD_TOKEN.substring(0, 10) + '...' : 'í† í°ì´ ì—†ìŠµë‹ˆë‹¤');

// ë´‡ ë¡œê·¸ì¸
client.login(process.env.DISCORD_TOKEN).catch(error => {
  console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error.message);
});
